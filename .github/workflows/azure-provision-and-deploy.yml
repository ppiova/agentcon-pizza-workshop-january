name: Provision + Deploy (Azure Static Web Apps)

on:
  workflow_dispatch:
    inputs:
      location:
        description: Azure region
        required: false
        default: westus
      resourceGroupName:
        description: Resource group name
        required: false
        default: rg-agentcon-pizza-workshop-january

permissions:
  id-token: write
  contents: read

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build VitePress
        run: npm run docs:build

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Provision Azure resources (Bicep)
        id: provision
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            location='${{ inputs.location }}'
            rg='${{ inputs.resourceGroupName }}'

            echo "Provisioning RG=$rg in $location"
            outputs=$(az deployment sub create \
              -l "$location" \
              -f infra/subscription.bicep \
              -p location="$location" resourceGroupName="$rg" \
              --query properties.outputs -o json)

            echo "Bicep outputs: $outputs"

            staticSiteName=$(echo "$outputs" | jq -r '.staticSiteName.value')
            echo "staticSiteName=$staticSiteName" >> "$GITHUB_OUTPUT"
            echo "resourceGroupName=$rg" >> "$GITHUB_OUTPUT"

      - name: Fetch SWA deployment token (ARM listSecrets)
        id: swa_token
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            rg='${{ steps.provision.outputs.resourceGroupName }}'
            name='${{ steps.provision.outputs.staticSiteName }}'

            resourceId=$(az staticwebapp show -g "$rg" -n "$name" --query id -o tsv)

            # Call listSecrets via ARM. Response shape: { properties: { apiKey: "..." } }
            token=$(az rest \
              --method post \
              --url "https://management.azure.com${resourceId}/listSecrets?api-version=2023-01-01" \
              --query properties.apiKey -o tsv)

            echo "deploymentToken=$token" >> "$GITHUB_OUTPUT"

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa_token.outputs.deploymentToken }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: docs/.vitepress/dist
          api_location: ''
          output_location: ''
